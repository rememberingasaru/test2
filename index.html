<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Viewer</title>
    <style>
        body {
            margin: 0;
            background: #333;
            color: white;
            font-family: monospace;
            overflow: hidden;
        }

        #debug-console {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 150px;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            overflow-y: auto;
            z-index: 9999;
            padding: 10px;
            border-bottom: 1px solid #555;
            font-size: 12px;
        }

        #app-container {
            margin-top: 160px;
            /* Space for console */
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 160px);
        }

        .flip-book {
            display: none;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .page {
            background: white;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>

<body>

    <div id="debug-console">Debug Console Initialized...<br></div>

    <div id="app-container">
        <div id="book" class="flip-book"></div>
    </div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.min.js"></script>

    <script>
        // Debug Logger
        const consoleEl = document.getElementById('debug-console');
        function log(msg, type = 'INFO') {
            const line = document.createElement('div');
            line.textContent = `[${type}] ${msg}`;
            if (type === 'ERROR') line.style.color = 'red';
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
            console.log(`[${type}]`, msg);
        }
        window.onerror = (msg) => log(msg, 'ERROR');

        // Config
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const pdfPath = 'pp_chat_gpt.pdf';
        const bookEl = document.getElementById('book');
        let pdfDoc = null;
        let pageFlip = null;

        async function init() {
            try {
                log("Starting init...");
                localStorage.clear();
                log("LocalStorage cleared.");

                if (typeof pdfjsLib === 'undefined') throw new Error("PDF.js missing");
                if (typeof St === 'undefined') throw new Error("PageFlip missing");
                log("Libraries loaded.");

                log(`Loading PDF: ${pdfPath}`);
                pdfDoc = await pdfjsLib.getDocument(pdfPath).promise;
                log(`PDF Loaded. Pages: ${pdfDoc.numPages}`);

                // Create Pages
                const pages = [];
                for (let i = 0; i < pdfDoc.numPages; i++) {
                    const div = document.createElement('div');
                    div.className = 'page';
                    pages.push(div);
                }
                log("Page elements created.");

                // Init PageFlip (Simplified)
                pageFlip = new St.PageFlip(bookEl, {
                    width: 500, // Fixed size
                    height: 700,
                    size: 'fixed',
                    showCover: true
                });
                log("PageFlip initialized.");

                pageFlip.loadFromHTML(pages);
                log("Pages loaded into PageFlip.");

                // Render Content
                const pageNodes = pageFlip.getFlipController().getPageCollection().getPages();
                for (let i = 0; i < pdfDoc.numPages; i++) {
                    log(`Rendering page ${i + 1}...`);
                    const page = await pdfDoc.getPage(i + 1);
                    const viewport = page.getViewport({ scale: 1.5 });

                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    pageNodes[i].getElement().appendChild(canvas);
                }
                log("All pages rendered.");

                bookEl.style.display = 'block';
                log("Book displayed.");

            } catch (err) {
                log(err.message, 'ERROR');
                log(err.stack, 'ERROR');
            }
        }

        init();
    </script>
</body>

</html>